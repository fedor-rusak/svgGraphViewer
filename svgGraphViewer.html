<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>svgGraphViewer 0.7</title>

		<script>
			"use strict";

			//example data with graph like
			// A ---> B ---> C1
			//           `-> C2 --> D1
			//                  `-> D2
			const inputData = [
				{nodeName: "A", depends:[]},
				{nodeName: "B", depends: ["A"]},
				{nodeName: "C1", depends: ["B"]},
				{nodeName: "C2", depends: ["B"]},
				{nodeName: "D1", depends: ["C2"]},
				{nodeName: "D2", depends: ["C2"]}
			];
		</script>

		<script>
			"use strict";

			//Graph-like data structure.
			const coreGraph = function() {
				const generateGraphStructure = function() {
					//actual instance state
					var nodeNames = [],
					    nodePropertiesStorage = {};

					const shallowCopy = function(source) {
						return Object.assign({}, source);
					};

					const propertiesAreValid = function(properties) {
						Object.keys(properties).forEach(
							key => {
								if (typeof properties[key] === 'object') {
									throw Error("Only float, string, booleans allowed as properties!!! \n\n\nError with key: "+key+"\nWhole structure: "+JSON.stringify(properties));
								}
							}
						);

						return true;
					}

					const addNode = function(newName, newProperties) {
						newProperties = newProperties || {};

						if (nodePropertiesStorage[newName] === undefined
							&& typeof newProperties === 'object'
							&& propertiesAreValid(newProperties)) {
							nodePropertiesStorage[newName] = shallowCopy(newProperties);
							nodePropertiesStorage[newName]["name"] = newName;
							nodeNames.push(newName);
						}
					}

					const getNode = function(nodeName) {
						return shallowCopy(nodePropertiesStorage[nodeName]);
					}

					return {
						addNode,
						getNode
					};
				};

				//TESTS
				try {
					let testGraph = generateGraphStructure();

					let nodeName = "A";
					let nodeDescription = "A node";
					let nodeProperties = {description: nodeDescription};

					testGraph.addNode(nodeName, nodeProperties);
					if (testGraph.getNode(nodeName).description !== nodeDescription) {
						throw new Error("Adding node with properties failed!");
					}

					//someone modified added nodeProperties object
					nodeProperties.description = "NOT A node";
					if (testGraph.getNode(nodeName).description !== nodeDescription) {
						throw new Error("Node properties were modified without proper API call!");
					}

					testGraph.getNode(nodeName).description = "Maybe NOT A node?";
					if (testGraph.getNode(nodeName).description !== nodeDescription) {
						throw new Error("Node properties were modified without proper API call!");
					}

					let secondNodeName = "B";

					testGraph.addNode(secondNodeName, undefined);
					if (testGraph.getNode(secondNodeName).name !== secondNodeName) {
						throw new Error("Adding Node with empty properties failed!");
					}


					let noException = true;

					try {
						let thirdNodeName = "C";
						let invalidNodeProperties = {description: {description: "Objects NOT allowed as properties!"}};

						testGraph.addNode(thirdNodeName, invalidNodeProperties);
					}
					catch (e) {
						noException = false;
					}
					
					if (noException) {
						throw new Error("Node properties validation failed!");
					}
				}
				catch (e) {
					alert("Adding&Getting Node API failed!\n" + e);
					throw e;
				}

				try {
					let testGraph = generateGraphStructure();

					let nodeName = "A";
					let nodeData = {description: "A node"};
					testGraph.addNode(nodeName, nodeData);
					if (testGraph.getNodeNames().length !== 1) {
						throw new Error("Getting node names failed!");
					}

					testGraph.getNodeNames().push("Improper node adding!");
					if (testGraph.getNodeNames().length !== 1) {
						throw new Error("Getting node names encapsulation failed!");
					}
				}
				catch (e) {
					alert("Getting nodeNames API failed!\n" + e);
					throw e;
				}


				//module API
				return {
					generateGraphStructure
				}
			}();
		</script>

		<script>
			"use strict";

			window.onload = function () {
				const graphInstance = coreGraph.generateGraphStructure();
				alert("This is the first step in simple SVG graph Viewr application!" + "\nData: \n" +JSON.stringify(inputData, null, 4));
			};
		</script>
	</head>
	<body>
	</body>
</html>